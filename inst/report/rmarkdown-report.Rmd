---
title: "cytosel Run Report"
output: 
  html_document:
    toc: true
    toc_float: true
params:
  df: ""
  marker_selection: ""
  heatmap: ""
  umap: ""
  metric: ""
  config: ""
  tmpdir: ""
header-includes:
  - \usepackage{fontawesome5}
---

<style>
.main-container {
    max-width: 940px;
    margin-right: auto;
}
</style>

Below are the results of your cytosel antibody panel design run.

```{r message=FALSE, echo=F}
knitr::opts_knit$set(root.dir = params$tmpdir)
library(tidyverse)
library(DT)
library(yaml)
library(shiny)
library(printr)
library(reactable)
library(plotly)
library(htmltools)
library(fontawesome)
```


```{r, echo=FALSE}
htmltools::img(src = "cytosel-logo.png", 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding-top: 20px; padding-right:40px; width: 185px;')
```
## Antibody panel

```{r message=F, echo=F, width = 13}
reactable(params$df,
              searchable = TRUE,
                filterable = TRUE,
                groupBy = "Symbol",
                columns = list(`Host Species` = colDef(aggregate = "unique",
                  filterInput = function(values, name) {
                    tags$select(
                      # Set to undefined to clear the filter
                      onchange = sprintf("Reactable.setFilter('antibody-select', '%s', event.target.value || undefined)", name),
                      # "All" has an empty value to clear the filter, and is the default option
                      tags$option(value = "", "All"),
                      tags$html(multiple = T),
                      lapply(unique(values), tags$option),
                      "aria-label" = sprintf("Filter %s", name),
                      style = "width: 100%; height: 28px"
                    )
                  }
                ),
                `Target` = colDef(aggregate = "unique"),
                `Product Category Tier 3` = colDef(
                  filterInput = function(values, name) {
                    tags$select(
                      # Set to undefined to clear the filter
                      onchange = sprintf("Reactable.setFilter('antibody-select', '%s', event.target.value || undefined)", name),
                      # "All" has an empty value to clear the filter, and is the default option
                      tags$option(value = "", "All"),
                      lapply(unique(values), tags$option),
                      "aria-label" = sprintf("Filter %s", name),
                      style = "width: 100%; height: 28px;"
                    )
                  }
                ),
#                 `Listed Applications` = colDef(
#                   filterable = TRUE,
#                   # Filter by case-sensitive text match
#                   filterMethod = JS("export function MultiSelectFilterFn(rows, id, filterValues) {
#     if (filterValues.length === 0) return rows;
# 
#     return rows.filter(r => filterValues.includes(r.values[id]));
# }")
#                 ),
                `External Link` = colDef(html = T),
                `Human Protein Atlas` = colDef(html = T)
                ),
                sortable = TRUE,
                elementId = "antibody-select")
```

## Selected markers {.tabset}

### Marker list vector

You selected the following markers to be included in your antibody panel. It can be copied directly as a R-compatible vector. 

```{r message=FALSE, echo=F, comment=NA}
with_quotes <- paste0("'", names(params$marker_selection), "'")
first_genes <- paste0(utils::head(with_quotes, n = length(with_quotes) - 1), collapse = " ", sep = ",")
all_genes <- paste0("c(", first_genes, " ", tail(with_quotes, n = 1), ")")
cat(all_genes)
```

### Marker/Cell-type table

```{r message=FALSE, echo=F, comment=NA}
reactable(data.frame(Marker = names(params$marker_selection),
                     Annotation = params$marker_selection),
          rownames = F,
           searchable = TRUE,
                filterable = TRUE)
```


## Heatmaps  {.tabset}

### Marker-marker correlation

```{r echo=F, warning=F, fig.width=9}
params$heatmap$correlation
```

### Marker Expression

```{r echo=F, warning=F, fig.width=9}
params$heatmap$expression
```

### Marker Z-score

```{r echo=F, warning=F, fig.width=9}
params$heatmap$z_score
```

## UMAPs {.tabset}

### All Markers

```{r echo = F, fig.width=8, fig.height=5, warning=F, message=F}
params$umap$all

```

### Selected Marker Panel

```{r echo = F, fig.width=8, fig.height=5, warning=F, message=F}
params$umap$top

```


## Metrics {.tabset}

### Distribution

```{r echo=F, warning=F, fig.width=10}
params$metric$plot
```


### Summary Table

```{r echo=F, warning=F, fig.width=10}
params$metric$table |> 
  datatable(options = list(autoWidth = FALSE))
```


## Config

Below is the configuration used during your run:

```{r echo = F,message=F}
params$config |> 
  datatable(options = list(autoWidth = FALSE))
```
